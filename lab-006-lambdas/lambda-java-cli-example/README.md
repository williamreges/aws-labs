# Lab 006 - Terraform for Lambda (Java Example)

## ğŸš€ Introduction

This directory contains the Terraform infrastructure used in the Java Lambda example lab. The files here provision the AWS resources necessary to package, publish, and test a simple Lambda function.

## ğŸ“‹ Prerequisites

- **Terraform:** Install Terraform (https://www.terraform.io/downloads.html).
- **AWS CLI / Credentials:** Have AWS credentials configured locally (e.g., `aws configure`).
- **AWS Account:** Account with permissions to create IAM, Lambda, and auxiliary resources.
- **Default Region:** `sa-east-1` is the region used by default in this project.

## âš™ï¸ Infrastructure Components

This set of files creates and configures AWS resources needed for the Lambda function in the example. Main artifacts:

- IAM roles and policies for Lambda execution
- Lambda function (deployment via package generated by Maven)
- Auxiliary resources declared as data sources and outputs

## Project Structure

```
infra/terraform/
â”œâ”€â”€ provider.tf          # AWS provider configuration (region and version)
â”œâ”€â”€ main.tf              # Main resources (lambda, iam, etc.)
â”œâ”€â”€ variables.tf         # Input variables
â”œâ”€â”€ locals.tf            # Local variables
â”œâ”€â”€ outputs.tf           # Values exported after apply
â”œâ”€â”€ data.tf              # Data sources (e.g., finding AMIs or ARNs)
â”œâ”€â”€ iam.tf               # Policies/trusts and roles (organized here)
â”œâ”€â”€ lambda.tf            # Lambda resources (function, permission, alias)
â”œâ”€â”€ versions.tf          # Terraform/providers version constraints
â””â”€â”€ 02_maven_package.sh   # Auxiliary script used by the repository
```

> Note: the repository contains auxiliary scripts in `infra/aws-cli/` for complementary operations (create role, package via Maven, create/update Lambda via AWS CLI). Use them when you prefer a CLI workflow instead of pure Terraform.

## ğŸ”§ Variables and Standards

Variables are defined in `variables.tf`. Main expected variables:

- `regiao` (string): AWS region (default: `sa-east-1`).
- `lambda_function_name` (string): Base name of the Lambda function.
- `runtime` (string): Lambda runtime (e.g., `java17`).
- `handler` (string): Handler of the Java function.
- `s3_bucket` / `s3_key` (when used): package location, if packaging externally.

To customize, create a `terraform.tfvars` file or pass `-var` in the CLI:

```bash
terraform apply -var="regiao=us-east-1" -var="lambda_function_name=my-lambda"
```

## ğŸ“¤ Outputs

The outputs defined in `outputs.tf` return useful information after `apply`:

- `lambda_function_arn` - ARN of the created Lambda function
- `lambda_alias` - alias created (if applicable)
- `iam_role_arn` - ARN of the role used by Lambda

## ğŸ“¦ Deploy Guide (Terraform)

1. Enter the Terraform folder:

```bash
cd infra/terraform
```

2. Initialize the Terraform directory:

```bash
terraform init
```

3. Review the execution plan:

```bash
terraform plan
```

4. Apply the configuration:

```bash
terraform apply
```

5. (Optional) Remove the created infrastructure:

```bash
terraform destroy
```

## Alternative workflow (AWS CLI / Maven scripts)

The repository contains scripts for alternative workflows that package the JAR via Maven and use AWS CLI to create/update the Lambda. Example:

```bash
cd infra/aws-cli
./generator-jar.sh    # Packages the function (uses Maven in the app/ directory)
./03_create_lambda.sh    # Creates the function via AWS CLI
./04_update_latest_lambda.sh # Updates the Lambda code
```

Use these scripts if you want to explicitly control the deployment pipeline instead of using Terraform to manage the Lambda code.

## âš ï¸ Important Notes

- **State:** The `terraform.tfstate` file contains the infrastructure state. Do not commit this file to the repository; use a remote backend for team collaboration (S3 + DynamoDB).
- **IAM Permissions:** When applying, verify permissions needed to create roles and policies.
- **Region / AZs:** Adjust `var.regiao` as needed.
- **Java Packaging:** The Lambda source code is in `app/validadigitocpffunction/src/main/java`. Use `pom.xml` to generate the JAR before manual operations.

## ğŸ“º Verification in AWS Console

After `terraform apply`, verify in the AWS Console:

- Lambda â†’ Functions: confirm the function and version/alias
- IAM â†’ Roles & Policies: verify the associated role
- CloudWatch â†’ Lambda function logs

## ğŸ”— References

- Terraform: https://developer.hashicorp.com/terraform
- AWS Provider: https://registry.terraform.io/providers/hashicorp/aws/latest

---

